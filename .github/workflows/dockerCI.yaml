
name: Docker CI

on:
  push:
    branches:
      - feature/gh-test
jobs:

  build:

    runs-on: ubuntu-latest

    env:
      ACR_IMAGE_URL    : ${{ secrets.ACR_REG }}.azurecr.io/${{ secrets.ACR_REPO }}
      # These are used in if: conditions
      ACR_LOGGED_IN    : false
      DKR_IMG_IS_BUILT : false

    steps:
    - uses: actions/checkout@v1
    - uses: azure/docker-login@v1
      with:
        login-server: ${ACR_IMAGE_URL} # default: index.docker.io
        username: ${{ secrets.SERVICE_PRINCIPAL_ID }}
        password: ${{ secrets.SERVICE_PRINCIPAL_SECRET }}

    - name: Build Container
      if: ${{ env.ACR_LOGGED_IN == 'true' }}
      run: |
        # Build Image
        docker build -t image .
        # Set variable is successful
        [[ $? == 0 ]] && echo "::set-env name=DKR_IMG_IS_BUILT::true"

    - name: Docker Push
      if: ${{ env.DKR_IMG_IS_BUILT == 'true' }}
      run: |
        # Tag and push the docker image
        IMAGE_ID="${ACR_IMAGE_URL}"
        docker tag image $IMAGE_ID:stable
        docker push $IMAGE_ID
